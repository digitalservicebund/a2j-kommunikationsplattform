import { http, HttpResponse } from "msw";

import { getGerichte } from "./controllers/gerichte.js";
import { getAuthTokens } from "./controllers/tokenExchange.js";
import {
  filterVerfahrenByGericht,
  getAllVerfahren,
  getVerfahrenById,
  paginateVerfahren,
  searchVerfahren,
  sortVerfahren,
} from "./controllers/verfahren.js";

/**
 * All defined Handlers intercept a request and handle its response
 *
 * This file was initially AUTO GENERATED by [msw-auto-mock](https://github.com/zoubingwu/msw-auto-mock)
 *
 * @see https://mswjs.io/docs/concepts/request-handler
 * @see https://mswjs.io/docs/basics/intercepting-requests
 * @see https://mswjs.io/docs/basics/mocking-responses
 */

// KOMPLA_API_URL
const mockKomplaApiUrl = "https://app.kompla-justiz.sinc.de";
// KOMPLA_IDP_ISSUER
const mockKomplaIdpIssuer = "https://login.kompla-justiz.sinc.de";

export const handlers = [
  // Verfahren
  http.get(
    `${mockKomplaApiUrl}/:environment/api/v1/verfahren`,
    async ({ request }) => {
      const url = new URL(request.url);
      const offsetParam = url.searchParams.get("offset");
      const limitParam = url.searchParams.get("limit");
      const gerichtParam = url.searchParams.get("gericht");
      const sortParam = url.searchParams.get("sort");
      const searchParam = url.searchParams.get("search_text");

      let filteredVerfahren = getAllVerfahren();

      if (gerichtParam) {
        filteredVerfahren = filterVerfahrenByGericht(
          filteredVerfahren,
          gerichtParam,
        );
      }

      if (searchParam) {
        filteredVerfahren = searchVerfahren(filteredVerfahren, searchParam);
      }

      if (sortParam) {
        filteredVerfahren = sortVerfahren(filteredVerfahren, sortParam);
      }

      const paginatedVerfahren = paginateVerfahren(
        filteredVerfahren,
        offsetParam,
        limitParam,
      );

      const getVerfahrenResponse = [paginatedVerfahren, { status: 200 }];
      return HttpResponse.json(...getVerfahrenResponse);
    },
  ),

  http.get(`${mockKomplaApiUrl}/:environment/api/v1/gerichte`, async () => {
    const gerichteResponse = [getGerichte(), { status: 200 }];
    return HttpResponse.json(...gerichteResponse);
  }),

  // endpoint is not used by the frontend at the moment
  http.get(
    `${mockKomplaApiUrl}/:environment/api/v1/verfahren/:verfahrenId`,
    async ({ params }) => {
      const requestedVerfahren = getVerfahrenById(params.verfahrenId);

      console.log("Requested verfahren:", requestedVerfahren);

      const resultArray = [requestedVerfahren, { status: 200 }];

      return HttpResponse.json(...resultArray);
    },
  ),

  // KomPla IdP Token Exchange
  http.post(
    `${mockKomplaIdpIssuer}/realms/:environment/protocol/openid-connect/token`,
    () => {
      const post200Response = [getAuthTokens(), { status: 200 }];
      return HttpResponse.json(...post200Response);
    },
  ),
];
